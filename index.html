<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Criss-Cross Count Trainer</title>
    <style>
        :root {
            --radius: 0.625rem;
            --background: oklch(1 0 0);
            --foreground: oklch(0.145 0 0);
            --card: oklch(1 0 0);
            --card-foreground: oklch(0.145 0 0);
            --primary: oklch(0.205 0 0);
            --primary-foreground: oklch(0.985 0 0);
            --secondary: oklch(0.97 0 0);
            --secondary-foreground: oklch(0.205 0 0);
            --muted: oklch(0.97 0 0);
            --muted-foreground: oklch(0.556 0 0);
            --accent: oklch(0.97 0 0);
            --accent-foreground: oklch(0.205 0 0);
            --border: oklch(0.922 0 0);
            --input: oklch(0.922 0 0);
            --ring: oklch(0.708 0 0);
            --good: #38a169;
            --bad: #e53e3e;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            border-color: var(--border);
        }

        body {
            font-family: ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            background: var(--secondary);
            min-height: 100vh;
            color: var(--foreground);
            padding: 20px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 24px;
        }

        header h1 {
            font-size: 1.875rem;
            font-weight: 600;
            letter-spacing: -0.025em;
            color: var(--foreground);
            margin-bottom: 6px;
        }

        header p {
            color: var(--muted-foreground);
            font-size: 0.875rem;
            margin-bottom: 16px;
        }

        @media (min-width: 901px) {
            .container {
                display: grid;
                grid-template-columns: 1fr 380px;
                grid-template-rows: auto auto auto;
                row-gap: 4px;
                column-gap: 20px;
            }

            .container > header {
                grid-column: 1 / -1;
                grid-row: 1;
                margin-bottom: 0;
            }

            .board-section {
                grid-column: 1;
                grid-row: 2;
            }

            .bottom-pane {
                grid-column: 1;
                grid-row: 3;
                margin-top: 0;
            }

            .sidebar {
                grid-column: 2;
                grid-row: 2 / 4;
            }
        }

        @media (max-width: 900px) {
            .container {
                display: flex;
                flex-direction: column;
            }

            .sidebar {
                order: 10;
                margin-top: 16px;
            }
        }

        .board-section {
            background: var(--card);
            border-radius: var(--radius);
            padding: 16px 20px;
            border: 1px solid var(--border);
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        }

        .pip-display {
            text-align: center;
            padding: 6px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .pip-display.top {
            color: var(--muted-foreground);
        }

        .pip-display.bottom {
            color: var(--foreground);
        }

        .pip-display .diff {
            color: var(--muted-foreground);
        }

        .board-wrapper {
            position: relative;
            display: flex;
            align-items: stretch;
        }

        .side-column {
            flex: 1;
            background: #1e2a4a;
            border-radius: 4px 0 0 4px;
        }

        .off-column {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #1e2a4a;
            border-radius: 0 4px 4px 0;
        }

        .off-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2px 0;
        }

        .off-area#black-off {
            justify-content: flex-start;
        }

        .off-area#white-off {
            justify-content: flex-end;
        }

        .off-label {
            font-size: 0.6875rem;
            color: #8899bb;
            font-weight: 500;
        }

        .board-container {
            flex: 13;
            position: relative;
        }

        .point-numbers {
            display: flex;
            padding: 0 2px;
            background: var(--card);
        }

        .point-numbers.top {
            padding-bottom: 2px;
        }

        .point-numbers.bottom {
            padding-top: 2px;
        }

        .side-spacer {
            flex: 1;
        }

        .off-spacer {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .point-number-group {
            flex: 6;
            display: flex;
        }

        .point-number-group.left {
            padding-right: 4px;
        }

        .point-number-group.right {
            padding-left: 4px;
        }

        .point-num {
            flex: 1;
            text-align: center;
            font-size: 0.625rem;
            color: var(--muted-foreground);
        }

        .bar-spacer {
            flex: 1;
        }

        .board {
            position: relative;
            width: 100%;
            aspect-ratio: 1.35;
            background: #c5cfe0;
            border: none;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-radius: 4px;
        }

        .board-half {
            flex: 1;
            display: flex;
            position: relative;
        }

        .board-quadrant {
            flex: 6;
            display: flex;
            background: #c5cfe0;
            gap: 1px;
        }

        .board-quadrant.left {
            padding-right: 2px;
        }

        .board-quadrant.right {
            padding-left: 2px;
        }

        .bar {
            flex: 1;
            background: #1e2a4a;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .point {
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 0;
        }

        .point.top {
            justify-content: flex-start;
        }

        .point.bottom {
            justify-content: flex-end;
        }

        .point-triangle {
            position: absolute;
            width: 100%;
            height: 85%;
        }

        .point.top .point-triangle {
            top: 0;
            clip-path: polygon(50% 100%, 0% 0%, 100% 0%);
        }

        .point.bottom .point-triangle {
            bottom: 0;
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
        }

        .point.dark .point-triangle {
            background: #9aa8c2;
        }

        .point.light .point-triangle {
            background: #dce4f0;
        }

        .checkers-stack {
            position: relative;
            z-index: 5;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }

        .point.top .checkers-stack {
            padding-top: 2px;
        }

        .point.top .checker.stacked {
            margin-top: 0;
        }

        .point.bottom .checkers-stack {
            padding-bottom: 2px;
            flex-direction: column-reverse;
        }

        .point.bottom .checker.stacked {
            margin-bottom: 0;
            margin-top: 0;
        }

        .checker {
            width: 94%;
            aspect-ratio: 1;
            max-width: 52px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            margin: 0;
            box-sizing: border-box;
            flex-shrink: 0;
        }

        .checker.white {
            background: conic-gradient(from 0deg, #d0d0d0 0%, #808080 25%, #d0d0d0 50%, #808080 75%, #d0d0d0 100%);
            border: none;
            color: #333;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            position: relative;
        }

        .checker.white::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            right: 2px;
            bottom: 2px;
            border-radius: 50%;
            background: radial-gradient(circle at 35% 30%, #fcfcfa 0%, #f7f5f2 40%, #f0ede8 80%, #e8e5e0 100%);
            z-index: 0;
        }

        .checker.black {
            background: conic-gradient(from 0deg, #808890 0%, #606870 25%, #808890 50%, #606870 75%, #808890 100%);
            border: none;
            color: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.35);
            position: relative;
        }

        .checker.black::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            right: 2px;
            bottom: 2px;
            border-radius: 50%;
            background: radial-gradient(circle at 35% 30%, #5e6978 0%, #565f6e 40%, #4f5765 70%, #4a525f 100%);
            z-index: 0;
        }

        .checker.stacked {
            margin-top: -30%;
        }

        .checker.bar-checker,
        .checker.off-checker {
            width: var(--checker-size, 40px);
            height: var(--checker-size, 40px);
            aspect-ratio: auto;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1;
        }

        .checker-count {
            position: relative;
            z-index: 1;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 16px;
            justify-content: center;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
            font-size: 0.875rem;
            font-weight: 500;
            height: 2.25rem;
            padding: 0 1rem;
            gap: 0.5rem;
            border-radius: calc(var(--radius) - 2px);
            border: none;
            cursor: pointer;
            transition: all 0.15s;
            outline: none;
        }

        .btn-icon {
            margin-right: 4px;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .btn:focus-visible {
            outline: 2px solid var(--ring);
            outline-offset: 2px;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--primary-foreground);
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        }

        .btn-success {
            background: var(--bad);
            color: #fff;
        }

        .btn-warning {
            background: #d69e2e;
            color: #fff;
        }

        .btn-secondary {
            background: var(--secondary);
            color: var(--secondary-foreground);
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        }

        .btn-outline {
            background: var(--background);
            border: 1px solid var(--border);
            color: var(--foreground);
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        }

        .btn-outline:hover {
            background: var(--accent);
            color: var(--accent-foreground);
        }

        .btn-outline.active {
            background: var(--primary);
            color: var(--primary-foreground);
            border-color: var(--primary);
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .card {
            background: var(--card);
            border-radius: var(--radius);
            padding: 1.5rem;
            border: 1px solid var(--border);
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        }

        .card h3 {
            color: var(--card-foreground);
            margin-bottom: 12px;
            font-size: 0.875rem;
            font-weight: 600;
            letter-spacing: -0.01em;
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 8px;
        }

        .steps-label {
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--muted-foreground);
            margin-bottom: 6px;
        }

        .step-indicator {
            display: flex;
            gap: 6px;
            margin-bottom: 12px;
        }

        .step-dot {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
            background: var(--secondary);
            color: var(--muted-foreground);
            border: 1px solid var(--border);
        }

        .step-dot:hover {
            background: var(--accent);
        }

        .step-dot.active {
            background: var(--primary);
            color: var(--primary-foreground);
            border-color: var(--primary);
        }

        .calculation-display {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 0.6875rem;
            line-height: 1.7;
        }

        .calc-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 3px 0;
            border-bottom: 1px solid var(--border);
        }

        .calc-row:last-child {
            border-bottom: none;
        }

        .calc-row.highlight {
            background: var(--secondary);
            margin: 4px 0 0 0;
            padding: 6px 8px;
            border-radius: calc(var(--radius) - 2px);
            border: none;
        }

        .calc-label {
            color: var(--muted-foreground);
            font-size: 0.625rem;
        }

        .calc-formula {
            color: var(--foreground);
        }

        .calc-result {
            color: var(--bad);
            font-weight: 600;
        }

        .calc-result.negative {
            color: var(--good);
        }

        .result-box {
            background: var(--background);
            border-radius: calc(var(--radius) - 2px);
            padding: 12px;
            text-align: center;
            margin-top: 12px;
            border: 1px solid var(--border);
        }

        .result-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            text-align: center;
        }

        .result-item .label {
            font-size: 0.625rem;
            color: var(--muted-foreground);
            margin-bottom: 2px;
        }

        .result-item .value {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .result-item .value.black {
            color: var(--foreground);
        }

        .result-item .value.white {
            color: var(--muted-foreground);
        }

        .result-item .value.diff {
            color: var(--foreground);
        }

        .result-comparison {
            font-size: 0.6875rem;
            color: var(--muted-foreground);
        }

        .result-comparison .match {
            color: var(--bad);
        }

        .explanation-box {
        }

        .explanation-box h4 {
            color: var(--foreground);
            margin-bottom: 8px;
            font-size: 0.8125rem;
            font-weight: 600;
            letter-spacing: -0.01em;
        }

        .explanation-box p {
            font-size: 0.75rem;
            line-height: 1.5;
            color: var(--muted-foreground);
            margin-bottom: 6px;
        }

        .explanation-box ul, .explanation-box ol {
            font-size: 0.75rem;
            line-height: 1.6;
            color: var(--muted-foreground);
            margin: 6px 0 6px 16px;
            padding: 0;
        }

        .explanation-box li {
            margin-bottom: 4px;
        }

        .slice-diagram {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 3px;
            margin: 10px 0;
            padding: 8px;
            background: var(--background);
            border-radius: calc(var(--radius) - 2px);
        }

        .slice-box {
            text-align: center;
            padding: 4px 2px;
            border-radius: 3px;
            font-size: 0.625rem;
        }

        .slice-box.header {
            background: var(--secondary);
            color: var(--muted-foreground);
            font-size: 0.5rem;
        }

        .slice-box.value {
            font-weight: 600;
        }

        .slice-box.positive {
            background: rgba(229, 62, 62, 0.15);
            color: var(--good);
        }

        .slice-box.negative {
            background: rgba(56, 161, 105, 0.15);
            color: var(--bad);
        }

        .slice-box.zero {
            background: var(--secondary);
            color: var(--muted-foreground);
        }


        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--foreground);
            color: var(--background);
            padding: 10px 20px;
            border-radius: var(--radius);
            font-weight: 500;
            font-size: 0.875rem;
            opacity: 0;
            transition: all 0.3s;
            z-index: 1000;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .tutorial-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .tutorial-modal.show {
            display: flex;
        }

        .tutorial-content {
            background: var(--card);
            border-radius: var(--radius);
            padding: 24px;
            max-width: 550px;
            max-height: 85vh;
            overflow-y: auto;
            border: 1px solid var(--border);
            box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25);
        }

        .tutorial-content h2 {
            color: var(--foreground);
            margin-bottom: 16px;
            font-size: 1.25rem;
            font-weight: 600;
            letter-spacing: -0.025em;
        }

        .tutorial-content h4 {
            color: var(--foreground);
            margin: 16px 0 8px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .tutorial-content p, .tutorial-content li {
            line-height: 1.6;
            color: var(--muted-foreground);
            margin-bottom: 8px;
            font-size: 0.875rem;
        }

        .tutorial-content ul {
            padding-left: 20px;
        }

        .tutorial-content code {
            background: var(--secondary);
            padding: 2px 6px;
            border-radius: calc(var(--radius) - 4px);
            font-size: 0.75rem;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }

        .close-tutorial {
            margin-top: 16px;
        }

        .ua-markers {
            position: absolute;
            display: flex;
            font-size: 0.5625rem;
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 15;
            pointer-events: none;
            background: rgba(255,255,255,0.85);
            border-radius: 3px;
            padding: 2px 0;
        }

        .ua-markers.visible {
            opacity: 1;
        }

        .ua-markers.top {
            top: 4px;
            left: 0;
            right: 0;
        }

        .ua-markers.bottom {
            bottom: 4px;
            left: 0;
            right: 0;
        }

        .ua-marker-group {
            flex: 1;
            display: flex;
        }

        .ua-marker-spacer {
            width: 36px;
            flex-shrink: 0;
        }

        .ua-marker {
            flex: 1;
            text-align: center;
        }

        .ua-marker.positive {
            color: var(--bad);
        }

        .ua-marker.negative {
            color: var(--good);
        }

        .ua-marker.zero {
            color: var(--muted-foreground);
        }

        .bottom-pane {
            display: flex;
            gap: 20px;
            margin-top: 16px;
        }

        .bottom-left {
            background: var(--card);
            border-radius: var(--radius);
            padding: 1.5rem;
            border: 1px solid var(--border);
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        }

        .bottom-right {
            background: var(--card);
            border-radius: var(--radius);
            padding: 1.5rem;
            border: 1px solid var(--border);
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        }

        .bottom-left h3,
        .bottom-right h3 {
            color: var(--card-foreground);
            font-size: 0.875rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        @media (max-width: 900px) {
            .bottom-pane {
                flex-direction: column;
                max-width: 100%;
                width: 100%;
            }

            .bottom-left,
            .bottom-right {
                flex: none;
                width: 100%;
                min-width: 0;
            }

            .explanation-box {
                max-height: none;
            }
        }

        @media (max-width: 600px) {
            body {
                padding: 10px;
            }

            header h1 {
                font-size: 1.5rem;
            }

            header p {
                font-size: 0.8125rem;
            }

            .board-section {
                padding: 10px;
            }

            .controls {
                gap: 6px;
            }

            .btn {
                height: 2rem;
                padding: 0 0.75rem;
                font-size: 0.75rem;
            }
        }

    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Criss-Cross Count Trainer</h1>
            <p>Fast backgammon pip count method. Tiny numbers. Few operations.</p>
        </header>

        <div class="board-section">
                <div class="pip-display top" id="pip-top">Black - Pips: â€” </div>

                <div class="point-numbers top">
                    <div class="side-spacer"></div>
                    <div class="point-number-group left">
                        <span class="point-num">13</span>
                        <span class="point-num">14</span>
                        <span class="point-num">15</span>
                        <span class="point-num">16</span>
                        <span class="point-num">17</span>
                        <span class="point-num">18</span>
                    </div>
                    <div class="bar-spacer"></div>
                    <div class="point-number-group right">
                        <span class="point-num">19</span>
                        <span class="point-num">20</span>
                        <span class="point-num">21</span>
                        <span class="point-num">22</span>
                        <span class="point-num">23</span>
                        <span class="point-num">24</span>
                    </div>
                    <div class="off-spacer"><span class="off-label">OFF</span></div>
                </div>

                <div class="board-wrapper">
                    <div class="side-column left"></div>
                    <div class="board-container">
                        <div class="ua-markers top" id="ua-markers-top"></div>
                        <div class="board" id="board"></div>
                        <div class="ua-markers bottom" id="ua-markers-bottom"></div>
                    </div>
                    <div class="off-column">
                        <div class="off-area" id="black-off"></div>
                        <div class="off-area" id="white-off"></div>
                    </div>
                </div>

                <div class="point-numbers bottom">
                    <div class="side-spacer"></div>
                    <div class="point-number-group left">
                        <span class="point-num">12</span>
                        <span class="point-num">11</span>
                        <span class="point-num">10</span>
                        <span class="point-num">9</span>
                        <span class="point-num">8</span>
                        <span class="point-num">7</span>
                    </div>
                    <div class="bar-spacer"></div>
                    <div class="point-number-group right">
                        <span class="point-num">6</span>
                        <span class="point-num">5</span>
                        <span class="point-num">4</span>
                        <span class="point-num">3</span>
                        <span class="point-num">2</span>
                        <span class="point-num">1</span>
                    </div>
                    <div class="off-spacer"><span class="off-label">OFF</span></div>
                </div>

                <div class="pip-display bottom" id="pip-bottom">White - Pips: â€”</div>

                <div class="controls">
                    <button class="btn btn-primary" onclick="randomFromList()">
                        <span class="btn-icon">âžœ</span> Next Position
                    </button>
                    <button class="btn btn-secondary" onclick="copyXGID()">
                        <span class="btn-icon">ðŸ“‹</span> Copy XGID
                    </button>
                </div>

                <div class="controls" style="margin-top: 8px;">
                    <button class="btn btn-outline" id="step1-btn" onclick="toggleStep('1')">1</button>
                    <button class="btn btn-outline" id="step2-btn" onclick="toggleStep('2')">2</button>
                    <button class="btn btn-outline" id="stepUA-btn" onclick="toggleStep('UA')">UA</button>
                    <button class="btn btn-outline" id="stepBB-btn" onclick="toggleStep('BB')">BB</button>
                    <button class="btn btn-outline" id="stepTotal-btn" onclick="toggleStep('=')">=</button>
                </div>

        </div>

        <div class="sidebar">
            <div class="bottom-right">
                <h3 style="margin-bottom: 12px;">Calculation</h3>
                <div class="calculation-display" id="calculation-display">
                    <div class="calc-row">
                        <span class="calc-label">Step 1 (CCC):</span>
                        <span class="calc-formula" id="calc-1">â€”</span>
                    </div>
                    <div class="calc-row">
                        <span class="calc-label">Step 2 (Ã—5):</span>
                        <span class="calc-formula" id="calc-2">â€”</span>
                    </div>
                    <div class="calc-row">
                        <span class="calc-label">UA:</span>
                        <span class="calc-formula" id="calc-UA">â€”</span>
                    </div>
                    <div class="calc-row">
                        <span class="calc-label">BB:</span>
                        <span class="calc-formula" id="calc-BB">â€”</span>
                    </div>
                    <div class="calc-row highlight">
                        <span class="calc-label">Pip Diff:</span>
                        <span class="calc-result" id="calc-result">â€”</span>
                    </div>
                </div>

                <div class="result-comparison" id="result-comparison"></div>
            </div>
            <div class="bottom-left">
                <h3 style="margin-bottom: 12px;">Explanation</h3>
                <div class="explanation-box" id="step-explanation">
                    <h4>Select a Step</h4>
                    <p>Click a step button (1, 2, UA, BB, or =) to see visual highlights and explanation.</p>
                </div>
            </div>
        </div>

        <div class="bottom-pane">
            <div class="card">
                <h3>References</h3>
                <div style="font-size: 0.75rem; line-height: 1.6; color: var(--muted-foreground);">
                    <p style="margin-bottom: 8px;">
                        <a href="https://docs.google.com/document/d/1HVZ16CDjVmcH_fK2l3giedqwForgpnLmB5aRF_j1pmc/edit?tab=t.0#heading=h.wc0r227g8i1a" target="_blank" style="color: var(--foreground); text-decoration: underline; text-underline-offset: 2px;">Maxim Glaezer's CCC Method Paper</a>
                    </p>
                    <p>
                        <a href="https://www.bgonline.org/forums/webbbs_config.pl?noframes;read=208404" target="_blank" style="color: var(--foreground); text-decoration: underline; text-underline-offset: 2px;">Nack Ballard's Explanation</a>
                    </p>
                </div>
            </div>
            <div class="card">
                <h3>Legend</h3>
                <div style="font-size: 0.75rem; line-height: 1.6; color: var(--muted-foreground);">
                    <p><span style="color:var(--good);font-weight:600">Green / negative</span> = good for the race</p>
                    <p><span style="color:var(--bad);font-weight:600">Red / positive</span> = bad for the race</p>
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast">Copied to clipboard!</div>

    <div class="tutorial-modal" id="tutorial-modal">
        <div class="tutorial-content">
            <h2>How CCC Works</h2>

            <p>The Criss-Cross Count (CCC) is a mental calculation system for quickly determining the <strong>relative pip count difference</strong> in backgammon.</p>

            <h4>Core Concept</h4>
            <p>The board is divided into <strong>8 slices</strong> of 3 points each. Each slice has a value, and opposing slices always sum to 5.</p>

            <h4>Step 1a: Criss minus Cross (Ã—1)</h4>
            <p>Count checkers in "plus" zones minus "minus" zones:</p>
            <ul>
                <li><strong>Plus (green):</strong> Points 7-9, 22-24</li>
                <li><strong>Minus (red):</strong> Points 1-3, 16-18</li>
            </ul>

            <h4>Step 1b: Middle Zones (Ã—2)</h4>
            <p>Add twice the difference:</p>
            <ul>
                <li><strong>Plus:</strong> Points 10-12</li>
                <li><strong>Minus:</strong> Points 13-15</li>
            </ul>

            <h4>Step 2: Distribution (Ã—5)</h4>
            <p>Add 5 times (far minus near):</p>
            <ul>
                <li><strong>Far:</strong> White checkers on 13-25</li>
                <li><strong>Near:</strong> Black checkers on 1-12</li>
            </ul>

            <h4>UA: Unit Adjustment</h4>
            <p>Fine adjustment based on position within slice:</p>
            <ul>
                <li>First point of slice: Â±1</li>
                <li>Center point: 0</li>
                <li>Third point: âˆ“1</li>
            </ul>

            <h4>BB: Bar & Borne Off</h4>
            <p>Adjustments for bar and borne off:</p>
            <ul>
                <li>Black bar: âˆ’20, White bar: +20</li>
                <li>Black off: +5, White off: âˆ’5</li>
            </ul>

            <h4>Formula</h4>
            <p><code>Pip Diff = (Step 1 + Step 2) x 3 + UA + BB</code></p>

            <button class="btn btn-primary close-tutorial" onclick="closeTutorial()">Got it!</button>
        </div>
    </div>

    <script>
        const board = new Array(27).fill(0);
        let currentStep = null;
        let currentPositionIndex = null;
        let currentXGID = null;

        const xgidArray = [
            "XGID=-b--ABD-CA--bB---b-c-Bbbb-:0:0:1:00:1:0:3:0:10",
            "XGID=---B--C-C--bdC---bbeBAA---:0:0:1:51:1:4:3:0:10",
            "XGID=---B--C-D--bbBa--bceBB----:0:0:1:63:1:4:3:0:10",
            "XGID=--AB-BC-A--bbB----cgBBa---:0:0:1:63:1:4:3:0:10",
            "XGID=-aBC-BB--AAb-B-AaA-f--b-c-:0:0:1:00:1:4:3:0:10",
            "XGID=-aBC-BB--AAb-B-AaA-f--b-c-:0:0:1:42:1:4:3:0:10",
            "XGID=--c-BbD-C----DA-ac-e-a--A-:0:0:1:00:2:4:3:0:10",
            "XGID=-abBBcBCCB--A----a-bb-bb--:1:-1:1:64:2:4:3:0:10",
            "XGID=-AbCCcBBBB----a----bbabb--:1:-1:1:41:2:4:3:0:10",
            "XGID=-BbDA----a---b-------bbcc-:1:-1:1:33:2:4:3:0:10",
            "XGID=-b--B-D-C--AdC-A-c-db---A-:0:0:1:21:0:0:3:0:10",
            "XGID=--aBABB-B---bB-b-AccCbb---:0:0:1:41:0:0:1:0:10",
            "XGID=-CBBDAA--A--b-----Aacbbbc-:0:0:1:41:0:0:1:0:10",
            "XGID=----a-E-D-A--C-----AAbbdc-:1:1:1:43:0:0:3:0:10",
            "XGID=--bBbDBBCB---a--b--bbbb---:1:-1:1:21:0:0:1:0:10",
            "XGID=--BBa-B-Ba--dC---dAeA---AA:0:0:1:53:0:0:1:0:10",
            "XGID=-----aE-Ea--eC-A---bAbb-b-:0:0:1:66:0:0:1:0:10",
            "XGID=---aa-D-Ca-AcC-A-bbe-B---A:0:0:1:55:0:0:1:0:10",
            "XGID=a-CBBBCAA---------ccccb-A-:0:0:1:32:0:0:1:0:10",
            "XGID=aBCBaCBA-A--cAb--b-d-b----:1:-1:1:62:0:0:1:0:10",
            "XGID=---BBBBA---A-A---a-bcBBgb-:0:0:-1:00:0:0:1:0:10",
            "XGID=-BBCBBC-------------bAdbc-:1:1:1:22:0:0:1:0:10",
            "XGID=-aaB-BC--AA-dC---b-dc-BA--:1:1:1:53:0:0:1:0:10",
            "XGID=-BBABBBAA--------bbcbBacb-:1:1:1:55:0:0:1:0:10",
            "XGID=a-BBBBDA-----A----ccccb-A-:0:0:1:54:0:0:1:0:10",
            "XGID=-A-BCCBA---A--------bAAfd-:3:1:1:33:0:0:1:0:10",
            "XGID=-b----EBB---bE-abb-d--b-A-:0:0:1:51:0:0:1:0:10",
            "XGID=-a-BaBCBC-BA-------bab-ec-:1:-1:1:21:0:0:1:0:10",
            "XGID=aBBbBaC-----dB---cAdB---A-:1:-1:1:63:0:0:1:0:10",
            "XGID=-a--B-CAD---cC---baecA--A-:0:0:1:35:0:0:3:0:10",
            "XGID=-a--B-DAC---cC---baecA--A-:0:0:1:35:0:0:3:0:10",
            "XGID=-a----E-CA--dD---cbeB-----:0:0:1:51:0:0:1:0:10",
            "XGID=-a----E-CA--dD---d-fB-----:0:0:1:51:0:0:0:0:10",
            "XGID=----aCDCb---cD---c-d--b-A-:0:0:1:63:0:0:1:0:10",
            "XGID=----cCD-CB-Aa---bc-cbBa---:0:0:1:64:0:0:1:0:10",
            "XGID=----cCD-CC--a---bc-cbBa---:0:0:1:64:0:0:1:0:10",
            "XGID=---bBBBBB--B-ab-bc-e-B---A:0:0:1:54:0:0:1:0:10",
            "XGID=-b-B-CC---BAbC----bbAbbab-:1:-1:1:31:0:0:1:0:10",
            "XGID=-a--B-E-BB---bB---bdBbbb--:1:1:1:65:0:0:1:0:10",
            "XGID=a-ABBCB-A--------b-dBcbcB-:1:-1:1:43:0:0:1:0:10",
            "XGID=-a--a-E-C-AAcD--ac-db---A-:0:0:1:31:0:0:1:0:10",
            "XGID=aBBbBBE-B---------acbbb-b-:2:-1:1:32:0:0:1:0:10",
            "XGID=-----bE-D---cD--bc-e---AA-:0:0:1:33:0:0:1:0:10",
            "XGID=-aCC-BEB-----------bbcbda-:1:-1:1:32:0:0:1:0:10",
            "XGID=-b-aB-D-B--AdE-a---bb-b-aA:0:0:1:15:0:0:1:0:10",
            "XGID=-a-a-bEBB---bDa-abAe---A--:0:0:1:44:0:0:1:0:10",
            "XGID=-EBBBB------b--B----baecb-:0:0:1:62:0:0:1:0:10",
            "XGID=-EBBBB------b--B---bbbbcb-:0:0:1:62:0:0:1:0:10",
            "XGID=--ACBBC-----dB---c-bbbBb--:0:0:1:63:0:0:1:0:10",
            "XGID=-ABBBBB-----cB---c-cbbBb--:0:0:1:63:0:0:1:0:10",
            "XGID=--ACCBB-----dB---b-cbbBb--:0:0:1:63:0:0:1:0:10",
            "XGID=-a-B-BCBB-A--A---acd-bbbB-:0:0:1:52:0:0:1:0:10",
            "XGID=-a-B-BCBB-A--A--a-cd-bbbB-:0:0:1:52:0:0:1:0:10",
            "XGID=--b-BBCCB----------bcccbC-:0:0:1:41:0:0:1:0:10",
            "XGID=--b-BBCCBa---------cbcbbC-:0:0:1:41:0:0:1:0:10",
            "XGID=-B-ba-DCD--AA--a-a-bbbb-b-:0:0:1:00:0:0:1:0:10",
            "XGID=-c---BD-B---bE-Abc-e----A-:0:0:1:42:0:0:1:0:10",
            "XGID=-b---BD-B---cE-Abc-e----A-:0:0:1:42:0:0:1:0:10",
            "XGID=--B--BDbB---cC---b-db-b-B-:0:0:1:43:0:0:1:0:10",
            "XGID=--B--BCbB---dD---b-cb-b-B-:0:0:1:34:0:0:1:0:10",
            "XGID=---B-BDbB---cC---b-db-b-B-:0:0:1:34:0:0:1:0:10",
            "XGID=-b-BB-B-C-A-bCa--d-f----B-:0:0:1:43:0:0:1:0:10",
            "XGID=-a-BBaBBB--AbB----bcbbBb--:0:0:1:54:0:0:1:0:10",
            "XGID=-b----E-CA--eD---b-d--bAA-:0:0:1:51:0:0:1:0:10",
            "XGID=-BAAB-B-C---fB---bBdba----:0:0:1:43:0:0:1:0:10",
            "XGID=-bABBCBB--------bbbbcC-aa-:1:-1:1:31:0:0:1:0:10",
            "XGID=----BBCB---a-B-a--ac-cdCbA:1:1:1:62:0:0:1:0:10",
            "XGID=-A-a-bDBBaBab-----Bbbbb-B-:1:1:1:63:0:0:1:0:10",
            "XGID=-B-BCBB-a------b-cAb-cBcaA:1:-1:1:61:0:0:1:0:10",
            "XGID=aBCCbBB-----e-A--bAe---A--:1:-1:1:62:0:0:1:0:10",
            "XGID=-cBBBBCB---Bc----a-e-ab---:1:-1:1:34:0:0:1:0:10",
            "XGID=---BBCD-A--A--------acbBc-:1:1:1:61:0:0:1:0:10",
            "XGID=-aBBB-D-B----A---c--dbBbc-:0:0:1:51:0:0:3:0:10",
            "XGID=-aBBB-CAA----A---c--cbBccA:0:0:1:35:0:0:3:0:10",
            "XGID=-BaBBBB-----cB---cAcbBc---:1:-1:1:51:0:0:1:0:10",
            "XGID=----BBC-C-A-aa---bbd--bCcA:1:1:1:46:0:0:1:0:10",
            "XGID=-aB-BCB---A-aB----Bc-bbccA:0:0:1:53:0:0:1:0:10",
            "XGID=---C-bBBC--a--A-Bb-fB--ac-:0:0:1:66:0:0:1:0:10",
            "XGID=-CE-C-A-A----A------bbAca-:1:1:1:51:0:0:1:0:10",
            "XGID=-a-bBBB-C--AbC-b-b-cba--AA:0:0:1:16:0:0:1:0:10",
            "XGID=-a-bBBB-C--AbC---b-cba-bAA:0:0:1:61:0:0:1:0:10",
            "XGID=---aB-D-BA--dBb--b-dBAb-A-:0:0:1:43:0:0:1:0:10",
            "XGID=a-AABBB-B---a----bccbCBc--:0:0:1:64:0:0:1:0:10",
            "XGID=a-AABBB-B---a-----ecbCBc--:0:0:1:64:0:0:1:0:10",
            "XGID=--CBCBcA-----B-----bcbcBb-:1:1:1:42:0:0:1:0:10",
            "XGID=--BBBaC-A---bBb--e-e-B-A--:0:0:1:61:0:0:1:0:10",
            "XGID=-bB-B-DCC------b-bbcb-b-A-:1:-1:1:51:0:0:3:0:10",
            "XGID=-bB-B-DCC------b-bbcb-bA--:1:-1:1:51:0:0:3:0:10",
            "XGID=--aABCB-----bBb--e-eBB-A--:0:0:1:32:0:0:1:0:10",
            "XGID=----b-E-B--CbB---c-d-BbbA-:0:0:1:66:0:0:1:0:10",
            "XGID=-a--ABBBB----Cab-c-c-bCc--:0:0:1:64:0:0:1:0:10",
            "XGID=----BbCbB-B-AB-a-c-cBbA-b-:0:0:1:41:0:0:1:0:10",
            "XGID=--DBBbCb---B-B-----bcbbb--:0:0:1:42:0:0:1:0:10",
            "XGID=--DBBbCc---B-B----abcbb---:0:0:1:42:0:0:1:0:10",
            "XGID=-BBB-BB----------Ab-dfBcB-:1:1:1:55:0:0:1:0:10",
            "XGID=-BB-B-C-b--B-----b-B-bBde-:3:1:1:64:0:0:1:0:10",
            "XGID=-----BDbBC--aC-aAaae---bb-:1:-1:1:41:0:0:1:0:10",
            "XGID=-a---BD-C---bDA--dcd--Aa--:0:0:1:44:0:0:1:0:10",
            "XGID=---bB-D-B---cFa--d-c-b--A-:0:0:1:31:0:0:1:0:10",
            "XGID=-a-Ba-BCB---bBb-Ac-dB--b-A:1:-1:1:44:0:0:1:0:10",
            "XGID=-BAbaCD-C-----A-b-bbca--bA:0:0:1:36:0:0:1:0:10",
            "XGID=-B-BbCF---a--a--a--bbcba--:1:-1:1:41:0:0:1:0:10",
            "XGID=-----ACCBb--bC-----cCbbca-:1:1:1:32:0:0:1:0:10",
            "XGID=-BBDeBC---B--------bbaabb-:1:-1:1:31:0:0:1:0:10",
            "XGID=-DBBB-BA------b----cBbcbc-:2:1:1:64:0:0:1:0:10",
            "XGID=-bAddCCBBBB----------a-bb-:1:-1:1:62:0:0:1:0:10",
            "XGID=-----bEbC--CdD-----e----b-:0:0:1:52:0:0:1:0:10",
            "XGID=-a----E-Ca--eC---c-e--A-BA:0:0:1:63:0:0:3:0:10",
            "XGID=----a-E-C--adC---bbeB---AA:0:0:1:33:1:4:3:0:10",
            "XGID=a-a-B-E-CA--d-a--b-d-bB-B-:0:0:1:44:0:0:3:0:10"
        ];

        function parseXGID(xgid) {
            const newBoard = new Array(27).fill(0);
            let boardStr = xgid.replace('XGID=', '').split(':')[0];

            for (let i = 0; i < boardStr.length && i < 26; i++) {
                const c = boardStr[i];
                if (c === '-') {
                    newBoard[i] = 0;
                } else if (c >= 'A' && c <= 'Z') {
                    newBoard[i] = -(c.charCodeAt(0) - 'A'.charCodeAt(0) + 1);
                } else if (c >= 'a' && c <= 'z') {
                    newBoard[i] = c.charCodeAt(0) - 'a'.charCodeAt(0) + 1;
                }
            }
            return newBoard;
        }

        function boardToXGID() {
            if (currentXGID) {
                return currentXGID;
            }
            let xgid = 'XGID=';
            for (let i = 0; i < 26; i++) {
                const v = board[i];
                if (v === 0) {
                    xgid += '-';
                } else if (v < 0) {
                    xgid += String.fromCharCode('A'.charCodeAt(0) + (-v) - 1);
                } else {
                    xgid += String.fromCharCode('a'.charCodeAt(0) + v - 1);
                }
            }
            xgid += ':0:0:1:00:0:0:0:0:10';
            return xgid;
        }

        function setBoard(newBoard) {
            for (let i = 0; i < 27; i++) {
                board[i] = newBoard[i] || 0;
            }
            renderBoard();
            updateCalculation();
        }

        function setInitialPosition() {
            const newBoard = new Array(27).fill(0);
            newBoard[1] = 2;
            newBoard[6] = -5;
            newBoard[8] = -3;
            newBoard[12] = 5;
            newBoard[13] = -5;
            newBoard[17] = 3;
            newBoard[19] = 5;
            newBoard[24] = -2;
            setBoard(newBoard);
            currentXGID = null;
        }

        function randomFromList() {
            if (currentStep) {
                toggleStep(currentStep);
            }
            const index = Math.floor(Math.random() * xgidArray.length);
            const xgid = xgidArray[index];
            currentXGID = xgid;
            const newBoard = parseXGID(xgid);
            setBoard(newBoard);
            currentPositionIndex = index + 1;
        }

        function randomPosition() {
            const newBoard = new Array(27).fill(0);
            let blackLeft = Math.random() < 0.9 ? 15 : Math.floor(Math.random() * 14) + 1;
            let whiteLeft = Math.random() < 0.9 ? 15 : Math.floor(Math.random() * 14) + 1;

            const points = [];
            for (let i = 1; i <= 24; i++) points.push(i);

            for (let i = points.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [points[i], points[j]] = [points[j], points[i]];
            }

            let idx = 0;
            while (blackLeft > 0 && idx < 24) {
                const p = points[idx++];
                const n = 1 + Math.floor(Math.random() * Math.min(blackLeft, 5));
                newBoard[p] = n;
                blackLeft -= n;
            }

            idx = 0;
            while (whiteLeft > 0 && idx < 24) {
                const p = points[idx++];
                if (newBoard[p] !== 0) continue;
                const n = 1 + Math.floor(Math.random() * Math.min(whiteLeft, 5));
                newBoard[p] = -n;
                whiteLeft -= n;
            }

            const diff = Math.abs(pipCountWhite(newBoard) - pipCountBlack(newBoard));
            if (diff > 60) {
                randomPosition();
                return;
            }

            setBoard(newBoard);
            currentPositionIndex = null;
            currentXGID = null;
        }

        function pipCountBlack(b) {
            let pips = 0;
            for (let p = 0; p <= 25; p++) {
                if (b[p] > 0) pips += b[p] * (25 - p);
            }
            return pips;
        }

        function pipCountWhite(b) {
            let pips = 0;
            for (let p = 0; p <= 25; p++) {
                if (b[p] < 0) pips += (-b[p]) * p;
            }
            return pips;
        }

        function blackOff(b) {
            let off = 15;
            for (let i = 0; i < 25; i++) {
                if (b[i] > 0) off -= b[i];
            }
            return Math.max(0, off);
        }

        function whiteOff(b) {
            let off = 15;
            for (let i = 25; i > 0; i--) {
                if (b[i] < 0) off -= Math.abs(b[i]);
            }
            return Math.max(0, off);
        }

        function countFromTo(b, start, end, type) {
            let sum = 0;
            for (let i = start; i <= end; i++) {
                if (type === 0) sum += Math.abs(b[i]);
                else if (type < 0 && b[i] < 0) sum += Math.abs(b[i]);
                else if (type > 0 && b[i] > 0) sum += Math.abs(b[i]);
            }
            if (start === 0 && type === 0) sum += whiteOff(b);
            if (end === 25 && type === 0) sum += blackOff(b);
            return sum;
        }

        function pipCountCCC(b) {
            return - Math.abs(b[1]) + Math.abs(b[3])
                - Math.abs(b[4]) + Math.abs(b[6])
                - Math.abs(b[7]) + Math.abs(b[9])
                - Math.abs(b[10]) + Math.abs(b[12])
                - Math.abs(b[13]) + Math.abs(b[15])
                - Math.abs(b[16]) + Math.abs(b[18])
                - Math.abs(b[19]) + Math.abs(b[21])
                - Math.abs(b[22]) + Math.abs(b[24]);
        }

        function calculateCCC() {
            const zone7_9 = countFromTo(board, 7, 9, 0);
            const zone22_24 = countFromTo(board, 22, 24, 0);
            const zone1_3 = countFromTo(board, 1, 3, 0);
            const zone16_18 = countFromTo(board, 16, 18, 0);
            const S1a = zone7_9 + zone22_24 - zone1_3 - zone16_18;

            const zone10_12 = countFromTo(board, 10, 12, 0);
            const zone13_15 = countFromTo(board, 13, 15, 0);
            const S1b = S1a + 2 * (zone10_12 - zone13_15);

            const whiteOnTop = countFromTo(board, 13, 24, -1);
            const blackOnBottom = countFromTo(board, 1, 12, 1);
            const step2Value = 5 * (whiteOnTop - blackOnBottom);

            const UA = pipCountCCC(board);

            const whiteBarCount = Math.abs(board[25]);
            const blackBarCount = board[0];
            const bOff = blackOff(board);
            const wOff = whiteOff(board);
            const BB = -(blackBarCount * 20) + (whiteBarCount * 20) + (bOff * 5) - (wOff * 5);

            const total = (S1b + step2Value) * 3 + UA + BB;

            return {
                S1b, step2Value, UA, BB, total,
                zone7_9, zone22_24, zone1_3, zone16_18,
                zone10_12, zone13_15,
                whiteOnTop, blackOnBottom
            };
        }

        function updateCalculation() {
            const calc = calculateCCC();
            const pipBlack = pipCountBlack(board);
            const pipWhite = pipCountWhite(board);
            const actualDiff = pipWhite - pipBlack;

            document.getElementById('calc-1').innerHTML =
                `<span class="calc-result ${calc.S1b < 0 ? 'negative' : ''}">${calc.S1b}</span>`;

            document.getElementById('calc-2').innerHTML =
                `<span class="calc-result ${calc.step2Value < 0 ? 'negative' : ''}">${calc.step2Value}</span>`;

            document.getElementById('calc-UA').innerHTML =
                `<span class="calc-result ${calc.UA < 0 ? 'negative' : ''}">${calc.UA}</span>`;

            document.getElementById('calc-BB').innerHTML =
                `<span class="calc-result ${calc.BB < 0 ? 'negative' : ''}">${calc.BB}</span>`;

            const resultEl = document.getElementById('calc-result');
            resultEl.textContent = calc.total;
            resultEl.className = 'calc-result' + (calc.total < 0 ? ' negative' : '');

            const blackDiff = actualDiff > 0 ? `(${-actualDiff})` : `(+${-actualDiff})`;
            const whiteDiff = actualDiff < 0 ? `(${actualDiff})` : `(+${actualDiff})`;
            document.getElementById('pip-top').textContent = `Black - Pips: ${pipBlack} ${blackDiff}`;
            document.getElementById('pip-bottom').textContent = `White - Pips: ${pipWhite} ${whiteDiff}`;

            const compEl = document.getElementById('result-comparison');
            if (calc.total === actualDiff) {
                compEl.innerHTML = '';
            } else {
                compEl.innerHTML = `<span style="color: var(--good);">âœ— CCC: ${calc.total} vs Actual: ${actualDiff}</span>`;
            }
        }

        function renderBoard() {
            const boardEl = document.getElementById('board');
            boardEl.innerHTML = '';

            const topHalf = document.createElement('div');
            topHalf.className = 'board-half top';

            const bottomHalf = document.createElement('div');
            bottomHalf.className = 'board-half bottom';

            const topLeftQuad = document.createElement('div');
            topLeftQuad.className = 'board-quadrant left';

            const topRightQuad = document.createElement('div');
            topRightQuad.className = 'board-quadrant right';

            const bottomLeftQuad = document.createElement('div');
            bottomLeftQuad.className = 'board-quadrant left';

            const bottomRightQuad = document.createElement('div');
            bottomRightQuad.className = 'board-quadrant right';

            const topBar = document.createElement('div');
            topBar.className = 'bar';
            const bottomBar = document.createElement('div');
            bottomBar.className = 'bar';

            const whiteBarCount = Math.abs(board[25]);
            const blackBarCount = Math.abs(board[0]);

            if (whiteBarCount > 0) {
                const checker = document.createElement('div');
                checker.className = 'checker white bar-checker';
                if (whiteBarCount > 1) checker.textContent = whiteBarCount;
                topBar.appendChild(checker);
            }

            if (blackBarCount > 0) {
                const checker = document.createElement('div');
                checker.className = 'checker black bar-checker';
                if (blackBarCount > 1) checker.textContent = blackBarCount;
                bottomBar.appendChild(checker);
            }

            for (let i = 0; i < 6; i++) {
                const topPoint = 13 + i;
                topLeftQuad.appendChild(createPoint(topPoint, 'top', i));
            }

            for (let i = 0; i < 6; i++) {
                const topPoint = 19 + i;
                topRightQuad.appendChild(createPoint(topPoint, 'top', i));
            }

            for (let i = 0; i < 6; i++) {
                const bottomPoint = 12 - i;
                bottomLeftQuad.appendChild(createPoint(bottomPoint, 'bottom', i));
            }

            for (let i = 0; i < 6; i++) {
                const bottomPoint = 6 - i;
                bottomRightQuad.appendChild(createPoint(bottomPoint, 'bottom', i));
            }

            topHalf.appendChild(topLeftQuad);
            topHalf.appendChild(topBar);
            topHalf.appendChild(topRightQuad);

            bottomHalf.appendChild(bottomLeftQuad);
            bottomHalf.appendChild(bottomBar);
            bottomHalf.appendChild(bottomRightQuad);

            boardEl.appendChild(topHalf);
            boardEl.appendChild(bottomHalf);

            renderOffCheckers();
            renderUAMarkers();
            syncCheckerSizes();
        }

        function createPoint(pointNum, position, index) {
            const pointEl = document.createElement('div');
            const colorClass = (pointNum % 2 === 0) ? 'dark' : 'light';
            pointEl.className = `point ${position} ${colorClass}`;
            pointEl.dataset.point = pointNum;

            const triangle = document.createElement('div');
            triangle.className = 'point-triangle';
            pointEl.appendChild(triangle);

            const count = board[pointNum];
            if (count !== 0) {
                const stack = document.createElement('div');
                stack.className = 'checkers-stack';

                const absCount = Math.abs(count);
                const isBlack = count > 0;
                const displayCount = Math.min(absCount, 5);

                for (let i = 0; i < displayCount; i++) {
                    const checker = document.createElement('div');
                    checker.className = `checker ${isBlack ? 'black' : 'white'}`;
                    if (i > 0) checker.classList.add('stacked');
                    if (i === displayCount - 1 && absCount > 5) {
                        checker.innerHTML = '<span class="checker-count">' + absCount + '</span>';
                    }
                    stack.appendChild(checker);
                }

                pointEl.appendChild(stack);
            }

            return pointEl;
        }

        function renderOffCheckers() {
            const wOff = whiteOff(board);
            const bOff = blackOff(board);

            const whiteOffEl = document.getElementById('white-off');
            whiteOffEl.innerHTML = '';
            if (wOff > 0) {
                const checker = document.createElement('div');
                checker.className = 'checker white off-checker';
                checker.innerHTML = '<span class="checker-count">' + wOff + '</span>';
                whiteOffEl.appendChild(checker);
            }

            const blackOffEl = document.getElementById('black-off');
            blackOffEl.innerHTML = '';
            if (bOff > 0) {
                const checker = document.createElement('div');
                checker.className = 'checker black off-checker';
                checker.innerHTML = '<span class="checker-count">' + bOff + '</span>';
                blackOffEl.appendChild(checker);
            }
        }

        function renderUAMarkers() {
            const topMarkers = document.getElementById('ua-markers-top');
            const bottomMarkers = document.getElementById('ua-markers-bottom');

            const uaByPoint = {
                1: -1, 2: 0, 3: 1,
                4: -1, 5: 0, 6: 1,
                7: -1, 8: 0, 9: 1,
                10: -1, 11: 0, 12: 1,
                13: -1, 14: 0, 15: 1,
                16: -1, 17: 0, 18: 1,
                19: -1, 20: 0, 21: 1,
                22: -1, 23: 0, 24: 1
            };

            topMarkers.innerHTML = '';
            bottomMarkers.innerHTML = '';

            const topLeftGroup = document.createElement('div');
            topLeftGroup.className = 'ua-marker-group';
            for (let i = 0; i < 6; i++) {
                const topPoint = 13 + i;
                const marker = document.createElement('div');
                marker.className = 'ua-marker';
                const val = uaByPoint[topPoint];
                marker.textContent = val > 0 ? `+${val}` : val.toString();
                marker.classList.add(val > 0 ? 'positive' : val < 0 ? 'negative' : 'zero');
                topLeftGroup.appendChild(marker);
            }
            topMarkers.appendChild(topLeftGroup);

            const spacer1 = document.createElement('div');
            spacer1.className = 'ua-marker-spacer';
            topMarkers.appendChild(spacer1);

            const topRightGroup = document.createElement('div');
            topRightGroup.className = 'ua-marker-group';
            for (let i = 0; i < 6; i++) {
                const topPoint = 19 + i;
                const marker = document.createElement('div');
                marker.className = 'ua-marker';
                const val = uaByPoint[topPoint];
                marker.textContent = val > 0 ? `+${val}` : val.toString();
                marker.classList.add(val > 0 ? 'positive' : val < 0 ? 'negative' : 'zero');
                topRightGroup.appendChild(marker);
            }
            topMarkers.appendChild(topRightGroup);

            const bottomLeftGroup = document.createElement('div');
            bottomLeftGroup.className = 'ua-marker-group';
            for (let i = 0; i < 6; i++) {
                const bottomPoint = 12 - i;
                const marker = document.createElement('div');
                marker.className = 'ua-marker';
                const val = -uaByPoint[bottomPoint];
                marker.textContent = val > 0 ? `+${val}` : val.toString();
                marker.classList.add(val > 0 ? 'positive' : val < 0 ? 'negative' : 'zero');
                bottomLeftGroup.appendChild(marker);
            }
            bottomMarkers.appendChild(bottomLeftGroup);

            const spacer2 = document.createElement('div');
            spacer2.className = 'ua-marker-spacer';
            bottomMarkers.appendChild(spacer2);

            const bottomRightGroup = document.createElement('div');
            bottomRightGroup.className = 'ua-marker-group';
            for (let i = 0; i < 6; i++) {
                const bottomPoint = 6 - i;
                const marker = document.createElement('div');
                marker.className = 'ua-marker';
                const val = -uaByPoint[bottomPoint];
                marker.textContent = val > 0 ? `+${val}` : val.toString();
                marker.classList.add(val > 0 ? 'positive' : val < 0 ? 'negative' : 'zero');
                bottomRightGroup.appendChild(marker);
            }
            bottomMarkers.appendChild(bottomRightGroup);
        }

        function syncCheckerSizes() {
            requestAnimationFrame(() => {
                const boardChecker = document.querySelector('.board .checker:not(.bar-checker)');
                if (boardChecker) {
                    const size = boardChecker.offsetWidth;
                    document.documentElement.style.setProperty('--checker-size', size + 'px');
                }
            });
        }

        function toggleStep(step) {
            const wasActive = currentStep === step;

            document.querySelectorAll('.step-dot').forEach(d => d.classList.remove('active'));
            document.querySelectorAll('.btn-outline').forEach(b => b.classList.remove('active'));
            clearHighlights();
            document.getElementById('ua-markers-top').classList.remove('visible');
            document.getElementById('ua-markers-bottom').classList.remove('visible');

            if (wasActive) {
                currentStep = null;
                updateExplanation(null);
                return;
            }

            currentStep = step;
            let btnId;
            if (step === 'UA') btnId = 'stepUA-btn';
            else if (step === 'BB') btnId = 'stepBB-btn';
            else if (step === '=') btnId = 'stepTotal-btn';
            else btnId = `step${step}-btn`;
            document.getElementById(btnId)?.classList.add('active');

            showStepOverlay(step);
            updateExplanation(step);
        }

        function showStepOverlay(step) {
            if (step === '1') {
                showZoneOverlays();
            } else if (step === '2') {
                highlightDistribution();
            } else if (step === 'UA') {
                showUAOverlays();
            } else if (step === 'BB') {
                showBBOverlays();
            } else if (step === '=') {
            }
        }

        function showUAOverlays() {
            const boardEl = document.querySelector('.board');

            addSliceDividers(boardEl);

            const slices = [
                { minus: 1, zero: 2, plus: 3 },
                { minus: 4, zero: 5, plus: 6 },
                { minus: 7, zero: 8, plus: 9 },
                { minus: 10, zero: 11, plus: 12 },
                { minus: 13, zero: 14, plus: 15 },
                { minus: 16, zero: 17, plus: 18 },
                { minus: 19, zero: 20, plus: 21 },
                { minus: 22, zero: 23, plus: 24 }
            ];

            slices.forEach(slice => {
                const minusCount = Math.abs(board[slice.minus]);
                const plusCount = Math.abs(board[slice.plus]);
                const netUA = plusCount - minusCount;

                if (netUA === 0) return;

                const excessCount = Math.abs(netUA);
                if (netUA > 0 && board[slice.plus] !== 0) {
                    addUAOval(boardEl, slice.plus, '#e53e3e', excessCount, plusCount, netUA);
                }
                if (netUA < 0 && board[slice.minus] !== 0) {
                    addUAOval(boardEl, slice.minus, '#38a169', excessCount, minusCount, netUA);
                }
            });

            function addUAOval(boardEl, p, color, excessCount, totalCount, netUA) {
                const pointEl = boardEl.querySelector(`.point[data-point="${p}"]`);
                if (!pointEl) return;
                const isBottomHalf = p >= 1 && p <= 12;

                const checkers = pointEl.querySelectorAll('.checker');
                if (checkers.length === 0) return;

                const pointRect = pointEl.getBoundingClientRect();
                const startIndex = totalCount - excessCount;
                const endIndex = totalCount - 1;

                const firstChecker = checkers[Math.min(startIndex, checkers.length - 1)];
                const lastChecker = checkers[Math.min(endIndex, checkers.length - 1)];
                const firstRect = firstChecker.getBoundingClientRect();
                const lastRect = lastChecker.getBoundingClientRect();

                const checkerSize = firstRect.width;
                const ovalWidth = checkerSize + 6;

                let ovalTop, ovalHeight;
                if (isBottomHalf) {
                    ovalTop = Math.min(firstRect.top, lastRect.top) - pointRect.top - 2;
                    ovalHeight = Math.max(firstRect.bottom, lastRect.bottom) - Math.min(firstRect.top, lastRect.top) + 4;
                } else {
                    ovalTop = Math.min(firstRect.top, lastRect.top) - pointRect.top - 2;
                    ovalHeight = Math.max(firstRect.bottom, lastRect.bottom) - Math.min(firstRect.top, lastRect.top) + 4;
                }

                const oval = document.createElement('div');
                oval.className = 'zone-oval ua-oval';
                oval.style.position = 'absolute';
                oval.style.border = `3px solid ${color}`;
                oval.style.borderRadius = (ovalWidth / 2) + 'px';
                oval.style.pointerEvents = 'none';
                oval.style.zIndex = '10';
                oval.style.left = '50%';
                oval.style.transform = 'translateX(-50%)';
                oval.style.width = ovalWidth + 'px';
                oval.style.height = ovalHeight + 'px';
                oval.style.top = ovalTop + 'px';

                pointEl.appendChild(oval);

                const label = document.createElement('div');
                label.className = 'zone-oval ua-label';
                label.textContent = (netUA > 0 ? '+' : '') + netUA;
                label.style.position = 'absolute';
                label.style.color = color;
                label.style.fontWeight = 'bold';
                label.style.fontSize = '18px';
                label.style.zIndex = '11';
                label.style.left = '50%';
                const lastCheckerCenter = (lastRect.top + lastRect.height / 2) - pointRect.top;
                label.style.top = lastCheckerCenter + 'px';
                label.style.transform = 'translate(-50%, -50%)';
                pointEl.appendChild(label);
            }

            function addSliceDividers(boardEl) {
                const dividerPoints = [
                    { after: 15, half: 'top' },
                    { after: 21, half: 'top' },
                    { after: 10, half: 'bottom' },
                    { after: 4, half: 'bottom' }
                ];

                dividerPoints.forEach(dp => {
                    const pointEl = boardEl.querySelector(`.point[data-point="${dp.after}"]`);
                    if (!pointEl) return;

                    const divider = document.createElement('div');
                    divider.className = 'zone-oval ua-divider';
                    divider.style.position = 'absolute';
                    divider.style.width = '4px';
                    divider.style.height = '90%';
                    divider.style.backgroundColor = 'var(--foreground)';
                    divider.style.right = '-1px';
                    divider.style.zIndex = '5';
                    if (dp.half === 'top') {
                        divider.style.top = '0';
                    } else {
                        divider.style.bottom = '0';
                    }
                    pointEl.appendChild(divider);
                });

            }
        }

        function addBarOval(barEl, color, uaValue) {
            barEl.style.position = 'relative';
            const checker = barEl.querySelector('.checker');
            if (checker) {
                checker.style.outline = `3px solid ${color}`;
                checker.style.outlineOffset = '2px';
            }

            const label = document.createElement('div');
            label.className = 'zone-oval ua-label';
            label.textContent = (uaValue > 0 ? '+' : '') + uaValue;
            label.style.position = 'absolute';
            label.style.color = color;
            label.style.fontWeight = 'bold';
            label.style.fontSize = '16px';
            label.style.zIndex = '11';
            label.style.left = '50%';
            label.style.transform = 'translateX(-50%)';
            label.style.top = '75%';
            barEl.appendChild(label);
        }

        function addOffOval(offEl, color, uaValue, isWhiteOff) {
            offEl.style.position = 'relative';
            const checker = offEl.querySelector('.checker');
            if (checker) {
                checker.style.outline = `3px solid ${color}`;
                checker.style.outlineOffset = '2px';
            }

            const label = document.createElement('div');
            label.className = 'zone-oval ua-label';
            label.textContent = (uaValue > 0 ? '+' : '') + uaValue;
            label.style.color = color;
            label.style.fontWeight = 'bold';
            label.style.fontSize = '14px';

            if (isWhiteOff) {
                offEl.insertBefore(label, offEl.firstChild);
                label.style.marginBottom = '4px';
            } else {
                offEl.appendChild(label);
                label.style.marginTop = '4px';
            }
        }

        function showBBOverlays() {
            const boardEl = document.querySelector('.board');

            if (board[25] < 0) {
                const count = Math.abs(board[25]);
                const barEl = boardEl.querySelector('.board-half.top .bar');
                addBarOval(barEl, '#e53e3e', count * 20);
            }

            if (board[0] > 0) {
                const count = board[0];
                const barEl = boardEl.querySelector('.board-half.bottom .bar');
                addBarOval(barEl, '#38a169', -count * 20);
            }

            const bOff = blackOff(board);
            if (bOff > 0) {
                const offEl = document.getElementById('black-off');
                addOffOval(offEl, '#e53e3e', bOff * 5, false);
            }

            const wOff = whiteOff(board);
            if (wOff > 0) {
                const offEl = document.getElementById('white-off');
                addOffOval(offEl, '#38a169', -wOff * 5, true);
            }
        }

        function showZoneOverlays() {
            const boardEl = document.querySelector('.board');

            const zones = [
                { points: [13, 14, 15], color: '#38a169', sign: '-', multiplier: 2, isDouble: true, pos: 'top', quadrant: 'left', startIdx: 0 },
                { points: [16, 17, 18], color: '#38a169', sign: '-', multiplier: 1, isDouble: false, pos: 'top', quadrant: 'left', startIdx: 3 },
                { points: [22, 23, 24], color: '#e53e3e', sign: '+', multiplier: 1, isDouble: false, pos: 'top', quadrant: 'right', startIdx: 3 },
                { points: [10, 11, 12], color: '#e53e3e', sign: '+', multiplier: 2, isDouble: true, pos: 'bottom', quadrant: 'left', startIdx: 0 },
                { points: [7, 8, 9], color: '#e53e3e', sign: '+', multiplier: 1, isDouble: false, pos: 'bottom', quadrant: 'left', startIdx: 3 },
                { points: [1, 2, 3], color: '#38a169', sign: '-', multiplier: 1, isDouble: false, pos: 'bottom', quadrant: 'right', startIdx: 3 }
            ];

            zones.forEach(zone => {
                const firstPoint = boardEl.querySelector(`.point[data-point="${zone.points[0]}"]`);
                const lastPoint = boardEl.querySelector(`.point[data-point="${zone.points[2]}"]`);
                if (!firstPoint || !lastPoint) return;

                const quadrant = firstPoint.closest('.board-quadrant');
                if (!quadrant) return;

                let zoneCount = 0;
                zone.points.forEach(p => {
                    zoneCount += Math.abs(board[p]);
                });
                const zoneValue = zoneCount * zone.multiplier;

                const oval = document.createElement('div');
                oval.className = 'zone-oval';
                oval.style.position = 'absolute';
                oval.style.border = `3px solid ${zone.color}`;
                oval.style.pointerEvents = 'none';
                oval.style.zIndex = '10';
                oval.style.display = 'flex';
                oval.style.alignItems = 'center';
                oval.style.justifyContent = 'center';
                oval.style.flexDirection = 'column';

                const pointWidth = 100 / 6;
                const gap = 0.2;
                const left = zone.startIdx * pointWidth + (zone.startIdx === 0 ? 0 : gap);
                const width = 3 * pointWidth - gap;

                const sampleChecker = boardEl.querySelector('.checker');
                const checkerSize = sampleChecker ? sampleChecker.offsetHeight : 40;
                const borderRadius = checkerSize / 2 + 3;
                const ovalHeight = checkerSize * 5 + 3;

                oval.style.left = `${left}%`;
                oval.style.width = `${width}%`;
                oval.style.height = ovalHeight + 'px';
                oval.style.borderRadius = borderRadius + 'px';
                if (zone.pos === 'top') {
                    oval.style.top = '0';
                } else {
                    oval.style.bottom = '0';
                }

                const label = document.createElement('div');
                label.className = 'zone-label';
                label.style.color = zone.color;
                label.style.fontWeight = 'bold';
                label.style.textAlign = 'center';

                const isNarrow = window.innerWidth < 600;
                if (zone.isDouble) {
                    label.style.fontSize = isNarrow ? '14px' : '22px';
                    label.innerHTML = `${zone.sign}2 Ã— ${zoneCount} = ${zone.sign}${zoneValue}`;
                } else {
                    label.style.fontSize = isNarrow ? '28px' : '44px';
                    label.textContent = `${zone.sign}${zoneCount}`;
                }
                oval.appendChild(label);

                quadrant.style.position = 'relative';
                quadrant.appendChild(oval);
            });
        }

        function highlightPoints(points, type) {
            const boardEl = document.querySelector('.board');
            const colors = {
                'plus': { outline: '#e53e3e', bg: 'rgba(229, 62, 62, 0.2)' },
                'plusplus': { outline: '#276749', bg: 'rgba(39, 103, 73, 0.3)' },
                'minus': { outline: '#38a169', bg: 'rgba(56, 161, 105, 0.2)' },
                'minusminus': { outline: '#c53030', bg: 'rgba(197, 48, 48, 0.3)' },
                'positive': { outline: '#e53e3e', bg: 'rgba(229, 62, 62, 0.25)' },
                'negative': { outline: '#38a169', bg: 'rgba(56, 161, 105, 0.25)' }
            };
            const color = colors[type] || colors['positive'];

            points.forEach(pointNum => {
                const pointEl = boardEl.querySelector(`.point[data-point="${pointNum}"]`);
                if (pointEl) {
                    pointEl.style.outline = `3px solid ${color.outline}`;
                    pointEl.style.outlineOffset = '-3px';
                    pointEl.style.background = color.bg;
                    pointEl.dataset.highlighted = 'true';
                }
            });
        }

        function highlightDistribution() {
            const boardEl = document.querySelector('.board');

            for (let p = 13; p <= 24; p++) {
                if (board[p] < 0) {
                    const count = Math.abs(board[p]);
                    const pointEl = boardEl.querySelector(`.point[data-point="${p}"]`);
                    if (pointEl) {
                        addDistributionLabel(pointEl, `+${count}`, '#e53e3e', 'top');
                    }
                }
            }

            for (let p = 1; p <= 12; p++) {
                if (board[p] > 0) {
                    const count = board[p];
                    const pointEl = boardEl.querySelector(`.point[data-point="${p}"]`);
                    if (pointEl) {
                        addDistributionLabel(pointEl, `âˆ’${count}`, '#38a169', 'bottom');
                    }
                }
            }
        }

        function addDistributionLabel(el, text, color, half) {
            const checkers = el.querySelectorAll('.checker');
            if (checkers.length === 0) return;

            const lastChecker = checkers[checkers.length - 1];
            const checkerRect = lastChecker.getBoundingClientRect();
            const pointRect = el.getBoundingClientRect();

            el.style.position = 'relative';

            const label = document.createElement('div');
            label.className = 'zone-oval dist-label';
            label.textContent = text;
            label.style.position = 'absolute';
            label.style.left = '50%';
            label.style.transform = 'translateX(-50%)';
            label.style.color = color;
            label.style.fontWeight = 'bold';
            label.style.fontSize = '18px';
            label.style.zIndex = '15';

            const checkerCenterY = checkerRect.top + checkerRect.height / 2 - pointRect.top;
            label.style.top = checkerCenterY + 'px';
            label.style.transform = 'translate(-50%, -50%)';

            el.appendChild(label);
        }

        function clearHighlights() {
            const boardEl = document.querySelector('.board');
            if (!boardEl) return;
            boardEl.querySelectorAll('.point[data-highlighted]').forEach(el => {
                el.style.outline = '';
                el.style.outlineOffset = '';
                el.style.background = '';
                delete el.dataset.highlighted;
            });
            boardEl.querySelectorAll('.zone-oval').forEach(el => el.remove());
            boardEl.querySelectorAll('.zone-label').forEach(el => el.remove());

            document.querySelectorAll('.off-area .zone-oval').forEach(el => el.remove());
            document.querySelectorAll('.off-area .checker').forEach(el => {
                el.style.outline = '';
                el.style.outlineOffset = '';
            });
            document.querySelectorAll('.bar .checker').forEach(el => {
                el.style.outline = '';
                el.style.outlineOffset = '';
            });
        }

        function updateExplanation(step) {
            const expEl = document.getElementById('step-explanation');

            const explanations = {
                '1': {
                    name: '1',
                    title: 'Step 1: Criss-Cross',
                    text: `
                        <p>The board shows <strong>6 zones</strong> with calculated values:</p>
                        <ul>
                            <li><span style="color:var(--good);font-weight:600">green</span> = negative values</li>
                            <li><span style="color:var(--bad);font-weight:600">red</span> = positive values</li>
                        </ul>
                        <p style="font-size:0.75rem;color:var(--muted-foreground);margin-top:8px;">
                            <em>The leftmost zones count double, as described in the <a href="https://docs.google.com/document/d/1HVZ16CDjVmcH_fK2l3giedqwForgpnLmB5aRF_j1pmc/edit?tab=t.0#heading=h.wc0r227g8i1a" target="_blank" style="color:var(--foreground);text-decoration:underline;">CCC Method Paper</a>.</em>
                        </p>
                        <p><strong>Calculate:</strong> Sum all the values shown.</p>
                    `
                },
                '2': {
                    name: '2',
                    title: 'Step 2: Behind the Enemy Line (Ã—5)',
                    text: `
                        <p>The board highlights checkers in <strong>"enemy territory"</strong>:</p>
                        <ul>
                            <li>White checkers on the opposite side = <span style="color:var(--bad);font-weight:600">bad(red)</span></li>
                            <li>Black checkers on our side = <span style="color:var(--good);font-weight:600">good(green)</span></li>
                        </ul>
                        <p><strong>Calculate:</strong></p>
                        <ol style="margin-left:16px;">
                            <li>Count white checkers on top (<span style="color:var(--bad);font-weight:600">bad(red)</span>)</li>
                            <li>Subtract black checkers on bottom (<span style="color:var(--good);font-weight:600">good(green)</span>)</li>
                            <li>Multiply the result by 5</li>
                        </ol>
                    `
                },
                'UA': {
                    name: 'UA',
                    title: 'Unit Adjustment (UA)',
                    text: `
                        <p><span style="color:var(--foreground);font-weight:600">Dividers</span> mark 8 zones (3 points each). Within each zone, the center point is <strong>0</strong>, the outer edge (furthest from home) is <strong>+1</strong>, and the inner edge (closest to home) is <strong>-1</strong>.</p>
                        <p><strong>Finding Asymmetric Checkers:</strong> In each zone, cancel out checkers on the +1 edge against those on the -1 edge (ignore color). Only unpaired checkers count:</p>
                        <ul>
                            <li><span style="color:var(--bad);font-weight:600">Bad (+1)</span>: Excess checkers on the outer edge (furthest from home).</li>
                            <li><span style="color:var(--good);font-weight:600">Good (-1)</span>: Excess checkers on the inner edge (closest to home).</li>
                        </ul>
                        <p><strong>Calculate:</strong> Sum these values across all 8 zones.</p>
                    `
                },
                'BB': {
                    name: 'BB',
                    title: 'BB: Bar & Borne Off',
                    text: `
                        <p>Up until now you should have ignored borne off and on the bar checkers.</p>
                        <p>Apply the following adjustments:</p>
                        <ul>
                            <li>Â±20 for checkers on the bar</li>
                            <li>Â±5 for borne off checkers</li>
                        </ul>
                        <p>The sign depends on who benefits from these adjustments.<br>Opponent's checkers on the bar and your borne off checkers benefit you.</p>
                        <p>Adjustments for checkers on the <strong>bar</strong> and <strong>borne off</strong>:</p>
                        <ul>
                            <li><span style="color:var(--good);font-weight:600">good(green)</span>: black bar (âˆ’20 each), white off (âˆ’5 each)</li>
                            <li><span style="color:var(--bad);font-weight:600">bad(red)</span>: white bar (+20 each), black off (+5 each)</li>
                        </ul>
                        <p><strong>Calculate:</strong> Sum all bar/off values.</p>
                    `
                },
                '=': {
                    name: '=',
                    title: 'Final Calculation',
                    text: `
                        <p><strong>Formula:</strong></p>
                        <p style="margin-left:8px;font-size:1rem;font-weight:600;color:var(--foreground);">
                            Pip Diff = (Step 1 + Step 2) x 3 + UA + BB
                        </p>
                        <p style="margin-top:12px;"><strong>Breakdown:</strong></p>
                        <ol style="margin-left:16px;">
                            <li>Add Step 1 + Step 2</li>
                            <li>Multiply by 3</li>
                            <li>Add UA</li>
                            <li>Add BB</li>
                        </ol>
                        <p style="font-size:0.75rem;color:var(--muted-foreground);margin-top:8px;">
                            <em>The result is the exact pip count difference (White âˆ’ Black). Negative means we are ahead in the race.</em>
                        </p>
                    `
                }
            };

            if (step && explanations[step]) {
                expEl.innerHTML = `<h4>${explanations[step].title}</h4>${explanations[step].text}`;
            } else {
                expEl.innerHTML = `
                    <h4>Select a Step</h4>
                    <p>Click a step button (1, 2, UA, BB, or =) to see:</p>
                    <ul>
                        <li>Visual overlays on the board</li>
                        <li>Detailed explanation of the calculation</li>
                    </ul>
                `;
            }
        }

        function showFullCalculation() {
            const calc = calculateCCC();
            const pipBlack = pipCountBlack(board);
            const pipWhite = pipCountWhite(board);
            const step1plus2 = calc.S1b + calc.step2Value;
            const tripled = step1plus2 * 3;

            alert(
                `PIP DIFF CALCULATION\n\n` +
                `Step 1 (Criss-Cross): ${calc.S1b}\n` +
                `Step 2 (Ã—5): ${calc.step2Value}\n` +
                `UA: ${calc.UA}\n` +
                `BB: ${calc.BB}\n\n` +
                `Formula: (${calc.S1b} + ${calc.step2Value}) x 3 + ${calc.UA} + ${calc.BB}\n` +
                `       = ${step1plus2} x 3 + ${calc.UA} + ${calc.BB}\n` +
                `       = ${tripled} + ${calc.UA} + ${calc.BB}\n` +
                `       = ${calc.total}\n\n` +
                `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n` +
                `Pip Diff: ${calc.total}\n` +
                `Actual Difference: ${pipWhite - pipBlack}\n` +
                `Black Pips: ${pipBlack}\n` +
                `White Pips: ${pipWhite}`
            );
        }

        function copyXGID() {
            const xgid = boardToXGID();
            navigator.clipboard.writeText(xgid).then(() => {
                showToast('XGID copied!');
            }).catch(() => {
                showToast('Failed to copy');
            });
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }

        function showTutorial() {
            document.getElementById('tutorial-modal').classList.add('show');
        }

        function closeTutorial() {
            document.getElementById('tutorial-modal').classList.remove('show');
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeTutorial();
        });

        document.getElementById('tutorial-modal').addEventListener('click', (e) => {
            if (e.target.id === 'tutorial-modal') closeTutorial();
        });

        function clearStepSelection() {
            currentStep = null;
            document.getElementById('step1-btn')?.classList.remove('active');
            document.getElementById('step2-btn')?.classList.remove('active');
            document.getElementById('stepUA-btn')?.classList.remove('active');
            document.getElementById('stepBB-btn')?.classList.remove('active');
            document.getElementById('stepTotal-btn')?.classList.remove('active');
            clearHighlights();
            updateExplanation(null);
        }

        clearStepSelection();
        randomFromList();

        window.addEventListener('resize', () => {
            syncCheckerSizes();
            if (currentStep) {
                clearHighlights();
                showStepOverlay(currentStep);
            }
        });
    </script>
</body>
</html>
